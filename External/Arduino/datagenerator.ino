 #include <Arduino.h>

typedef struct{
  long timestamp;
  long measurements[4];
} Datapoint;


int mode = 0;
String pyComm = " ";
int j = 0;
//constants command keys
const int wait = 0;
const int triggerMode = 1;
const int constantMode = 3;
const int startRead = 2;
const int sendData = 8;
const int restart = 128;
const int hardReset = 255;
const int calibrateMode = 16;
const String endSend = "END";


  long fakedata[914] = {
                          486783469, 486928808, 486281563, 486420324,
                          486248776, 487643452, 487289305, 487062093,
                          487451182, 486839346, 487123242, 486044642,
                          487202799, 487343454, 486265844, 487653198,
                          487122386, 487417723, 486203296, 487614138,
                          487246448, 487833564, 487386545, 487200375,
                          487796381, 487071350, 486267336, 487106855,
                          486418611, 486318065, 486181326, 486775936,
                          486432822, 486999584, 486735020, 486053999,
                          487727460, 487357325, 487689888, 486863642,
                          487464458, 486422553, 487230433, 487811392,
                          487014966, 486420669, 486991605, 487730663,
                          487274301, 486869691, 487607676, 486724705,
                          486251936, 486699626, 487525579, 486676346,
                          487353509, 486492337, 487263087, 487490148,
                          487190281, 487273333, 487494575, 486934132,
                          487298983, 486982261, 486071065, 487055627,
                          487720531, 486956432, 486138268, 486087051,
                          487755938, 486054591, 486554699, 486301914,
                          487018868, 486407497, 487363236, 486856525,
                          486670125, 486445858, 487325319, 487115366,
                          486717038, 487275298, 487502637, 487444627,
                          486613621, 486237754, 487734603, 486122016,
                          487779660, 486926663, 486502192, 487483901,
                          487634220, 487002533, 486507783, 487438013,
                          486766925, 487831715, 486163059, 486706584,
                          486188349, 487513852, 486183685, 486776623,
                          486619618, 487081022, 487522568, 487410253,
                          486580910, 486650770, 487778654, 487684733,
                          487695824, 486837416, 486306527, 487434108,
                          487807261, 487495513, 486731864, 487814100,
                          486188678, 487267031, 486978319, 486746991,
                          487620461, 486632642, 486330394, 487504067,
                          487285316, 486640715, 486353035, 486440617,
                          486835208, 487167340, 486112087, 486585640,
                          487546547, 486114084, 486172811, 487235757,
                          487012501, 486145343, 486747383, 486978382,
                          486998318, 487376395, 487157343, 486435373,
                          486935285, 486719473, 487388941, 487185737,
                          487617840, 486408993, 486209760, 487044889,
                          487296738, 487605374, 486817698, 486506630,
                          487557080, 487189270, 487267513, 486063969,
                          486629202, 486407831, 487613170, 487290184,
                          486957621, 486564779, 486328299, 486982834,
                          487533452, 487635107, 486990104, 487750616,
                          486517764, 486575471, 487616929, 487729714,
                          486397643, 487166981, 486854543, 487042293,
                          487708798, 486199547, 487197319, 486130997,
                          487194057, 486888487, 487557551, 486104968,
                          486906377, 487340392, 486472425, 486226426,
                          487820122, 487697181, 487778444, 486918365,
                          486617969, 487216018, 487415096, 487244085,
                          486384028, 487086577, 486558061, 486202968,
                          486069110, 486233097, 486104290, 487110680,
                          487183651, 486873690, 486421083, 486909839,
                          487707001, 487149496, 486109503, 486103140,
                          487239458, 487629878, 486444079, 487396022,
                          487344857, 486985478, 487549139, 486668938,
                          486092772, 486807115, 487328838, 486481984,
                          486892752, 487139592, 487082784, 486910623,
                          487271832, 486434219, 487126389, 486465506,
                          487071245, 486925077, 487313275, 486148442,
                          486979027, 487818688, 487210008, 487457213,
                          487802075, 487559607, 487380147, 487829142,
                          486257837, 486576070, 486745736, 486867943,
                          487607708, 486626322, 487194458, 487679132,
                          486064998, 487299989, 487496146, 487046102,
                          486850272, 487694813, 486221090, 486590716,
                          486498405, 486868442, 486047399, 487418808,
                          486537197, 486819075, 486306775, 486677325,
                          487348433, 487137047, 486971179, 487421979,
                          487790082, 486372642, 486860512, 486355194,
                          487101659, 487038406, 486597566, 487268531,
                          487394639, 486668806, 487431987, 487661981,
                          486884946, 487453182, 487498023, 486563811,
                          487558471, 486356981, 486773580, 487261164,
                          487714257, 487136516, 486266329, 487699583,
                          486756979, 486544226, 486912184, 487061933,
                          486660705, 487497733, 486838976, 486236267,
                          486348058, 487425833, 487378514, 486996019,
                          486175847, 486905977, 486677517, 486988423,
                          486791652, 486312926, 487505407, 486392969,
                          486432703, 486442837, 487550562, 487173069,
                          487551782, 486455153, 487418314, 486610085,
                          487425195, 486983328, 486802478, 487515099,
                          486235685, 487225157, 487463097, 487069969,
                          486668089, 487140319, 486512470, 487247093,
                          486426655, 487361346, 487125591, 487081697,
                          487326263, 486257097, 487544767, 486571597,
                          486456255, 487057850, 487588568, 486399260,
                          487568911, 486072453, 486553177, 486908995,
                          487681735, 486760537, 487194532, 486256705,
                          487744647, 487397252, 486756238, 486277813,
                          487044532, 487015976, 487441461, 487536147,
                          487756892, 486746989, 487820750, 487827512,
                          486398684, 486122570, 487690345, 486277910,
                          486705731, 486592989, 487554296, 487804691,
                          486421765, 486251402, 487369018, 486666275,
                          487132689, 486337810, 487122382, 487295688,
                          487060934, 486634187, 487238049, 487184577,
                          486358299, 487716680, 487782949, 487533180,
                          486807475, 486968003, 487625844, 486344082,
                          487761559, 487531083, 487412361, 487583612,
                          486581756, 486551553, 487072070, 486136926,
                          486674777, 487793144, 487779780, 487734976,
                          487124027, 486933783, 486866844, 487487394,
                          486894010, 486965413, 487478238, 487557811,
                          487290548, 486354480, 487216864, 486232486,
                          487132913, 486421291, 487588023, 487010904,
                          486609315, 486814132, 486643149, 487208472,
                          487015774, 486861404, 487817962, 486112648,
                          487448739, 487322128, 486969811, 487140398,
                          487571096, 486501691, 486648849, 487166065,
                          487072173, 487058426, 487299082, 486801207,
                          487689014, 486857113, 486658604, 486763640,
                          486773997, 487080754, 487250769, 486296815,
                          486216118, 487680387, 486099253, 486939766,
                          487799117, 487586616, 487464068, 486949701,
                          487221021, 486899224, 486353877, 487365174,
                          487826565, 486209596, 486340597, 487284447,
                          487721089, 487075744, 487063662, 487292646,
                          487773948, 487384809, 486708392, 487375033,
                          487317396, 487388777, 487805054, 487250880,
                          486594090, 486218494, 486809846, 486660732,
                          486771290, 486604882, 487482067, 486460804,
                          486264551, 487084738, 486583877, 486201942,
                          487251112, 486295291, 487250164, 486849348,
                          487048853, 487696019, 486777946, 486939989,
                          487293558, 486830856, 486753516, 486805277,
                          486413910, 487036833, 487582956, 486183903,
                          487495214, 486253792, 486897889, 486331391,
                          486521839, 487289054, 487714284, 486408010,
                          486738879, 487551006, 486858862, 486331831,
                          486797860, 487753878, 487740738, 487045181,
                          486927045, 486815052, 487487551, 486822512,
                          486834819, 487721289, 486094899, 487145722,
                          486294594, 486808194, 486103137, 487562954,
                          486864776, 486376255, 487661943, 486638273,
                          486993328, 487207960, 487682116, 486965583,
                          486936444, 486368342, 486503309, 486720657,
                          487498270, 486163760, 487089325, 486344993,
                          486544944, 487147531, 487596672, 487259324,
                          486941323, 486824850, 487712153, 487471867,
                          487132366, 487436957, 486907337, 486710352,
                          487518498, 486501051, 487577114, 486583034,
                          486692835, 487521247, 487103852, 487760696,
                          487052201, 486650428, 487428514, 486486918,
                          486057758, 487703207, 487510887, 486144181,
                          487459254, 487211280, 486649644, 486345649,
                          487397229, 486249175, 487838708, 486467729,
                          486641282, 487032705, 486337488, 486613583,
                          487299063, 486998881, 486935658, 486291571,
                          487801446, 487388455, 487201652, 487402395,
                          486567633, 487612154, 487288027, 487585781,
                          486553824, 486702214, 487355688, 486818810,
                          487670324, 486709844, 487566825, 486522254,
                          487753259, 486225309, 486142434, 487267013,
                          487394194, 486889279, 486332693, 487546500,
                          487294141, 486374252, 486268522, 487509473,
                          486634615, 487678808, 486237804, 486987427,
                          487822431, 487179193, 486490867, 486154337,
                          486386932, 486432900, 486275624, 486332614,
                          486447414, 486322326, 486957327, 486251766,
                          486748542, 487091727, 486935549, 486077767,
                          487668283, 487189485, 486291740, 487656408,
                          487090115, 487583937, 487826368, 486441778,
                          486266727, 486529239, 486721606, 486682985,
                          486483032, 487566519, 487021569, 487350077,
                          487733767, 486884478, 487605173, 487195223,
                          486060778, 486801818, 487618864, 487277986,
                          487457267, 486763383, 487286463, 487744795,
                          486977666, 487505003, 487831052, 487595854,
                          487776813, 487199064, 487791479, 487352469,
                          486320157, 486561349, 487101897, 486750737,
                          486550904, 486573290, 486664896, 487435095,
                          486975045, 486807087, 486051158, 486276592,
                          486643037, 487577764, 487253223, 486562871,
                          486617824, 487635885, 486110017, 486231722,
                          487714186, 486569845, 486259261, 486534859,
                          487272748, 487103327, 487420045, 486208443,
                          487520649, 486993468, 487653691, 486867707,
                          487313732, 487752365, 486388298, 486879274,
                          487480953, 487678730, 486217434, 487011931,
                          486094497, 487336787, 487008450, 487714580,
                          487435913, 487253119, 487224456, 487363679,
                          486832608, 487240895, 487434481, 487659544,
                          487244194, 487800639, 487210116, 486281921,
                          487250667, 487468863, 487666570, 487255799,
                          487828839, 487827546, 486852798, 487685423,
                          487139319, 486466133, 487599852, 486832551,
                          486887137, 487728020, 487344107, 487542385,
                          487800787, 487639547, 487008224, 487464618,
                          486759577, 487492649, 487564766, 486075406,
                          487298241, 487233979, 486134945, 487020980,
                          487805142, 487285638, 487836014, 487108546,
                          487168751, 486911584, 486729284, 487003518,
                          487714216, 486045351, 486659780, 487308725,
                          486413702, 487676098, 487316099, 487088985,
                          486627386, 486116070, 486047910, 487319645,
                          487160364, 487397516, 487741024, 486549968,
                          486590112, 486873631, 486550559, 487452723,
                          487327770, 486085595, 486789300, 487093116,
                          487466584, 486882600, 486128233, 486315862,
                          486997125, 487655158, 487162002, 487697217,
                          486788921, 487579255, 486227336, 486769418,
                          486282487, 486081840, 486275956, 486159933,
                          486438367, 486389872, 486870795, 487389314,
                          486460970, 486640555, 486526329, 487148798,
                          486603799, 487071628, 486261349, 486207644,
                          487029575, 486385500, 487603761, 486135124,
                          486635772, 486088049, 486582043, 487299877,
                          486979390, 487804810, 487342384, 486088964,
                          486330802, 487168889, 486079118, 487164256,
                          486050063, 486052406, 486835104, 486172517,
                          487061175, 486480621, 486779571, 486515423,
                          486877204, 487176039, 487646783, 486197040,
                          486886772, 486352372, 486509243, 487205206,
                          486599644, 486523612, 487084221, 487831583,
                          486083290, 486717482, 487283933, 486232715,
                          487661197, 486560640, 487099153, 487025722,
                          486655020, 486838524, 486981531, 486430568,
                          486247385, 487389468, 487805274, 486889031,
                          486385692, 487394700, 487753779, 487020725,
                          486821138, 486767682, 486813970, 486551085,
                          486383454, 487534932, 486563219, 486806155,
                          486661065, 486047843, 487530384, 487730237,
                          486584453, 486788040, 486578769, 487194780,
                          486260875, 486252142, 487204150, 486552454,
                          487050775, 486368041};


void setup() {
  Serial.begin(115200);
  delay(10);
  Serial.println();
  Serial.println("serial connection made");
 
  
//  mode = wait;
}

void loop() {
  Serial.println(mode);
  switch(mode)
  {
    
    case wait:
    {
      // blocking wait for a single byte communication from serial connection
      Serial.println("Waiting");
      while (!Serial.available());
      Serial.println("Done Waiting ");
      pyComm = Serial.readString();
      Serial.println(pyComm);
      if (pyComm.toInt() == constantMode or pyComm == "3"){
        mode = pyComm.toInt();  
      }
      break;
    } 
    case constantMode:{
      Serial.println("Starting to record");
      Serial.flush();
      Datapoint data[100];
      while(!Serial.available()){
        for(int i = 0; i < 100; i++){
          data[i].timestamp = millis();
          data[i].measurements[0] = fakedata[j];
          data[i].measurements[1] = fakedata[j+1];
          data[i].measurements[2] = fakedata[j+2];
          data[i].measurements[3] = fakedata[j+3];
          j = j + 4;
          if (j > 914){
            j = 0;
          }
        }
      }
      Serial.println("Done recording");
      pyComm = Serial.readString();
      Serial.println(pyComm.toInt());
      if (pyComm.toInt() == sendData or pyComm == "8"){
          for(int i = 0; i < 10; i++){
            Serial.println(String(data[i].timestamp));
            Serial.println(String(data[i].measurements[0]));
            Serial.println(String(data[i].measurements[1]));
            Serial.println(String(data[i].measurements[2]));
            Serial.println(String(data[i].measurements[3]));
            delay(500);
          }
          Serial.println(endSend);
      }else {
        mode = wait;
      }
      break;
    } 
    case triggerMode:
    { 
      break;
    } 
    default:{
      mode = wait;
      break;
    } 
  }

}